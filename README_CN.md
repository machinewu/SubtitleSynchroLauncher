# Subtitle Synchro Launcher
[-->English Documentation<--](./README.md)
Subtitle Synchro Launcher 是一个方便字幕调轴工具使用的通用GUI启动器。它允许用户通过简单的拖放操作添加源视频 / 音频、源字幕和目标视频 / 音频文件，然后调用字幕调轴工具同步字幕的时间轴。期间可以对字幕进行前期后期的一些适配处理。

- 支持各类命令行方式的字幕调轴工具（[Sushi](https://github.com/FichteFoll/Sushi)、[alass](https://github.com/kaegi/alass)、[FFsubsync](https://github.com/smacke/ffsubsync)…），且设置其各项参数
- 支持并发处理多个任务，支持运行途中停止
- 支持拖放文件/文件夹作添加
- 支持调整文件列表，文件列表支持文件名字母数字混合排序(能按数字正确排序如```a8.mkv、a9.mkv、a10.mkv、a11.mkv…```这种数字位不对齐的文件名)
- 支持定制界面元素风格
- 支持多语言

![operation_cn](https://github.com/user-attachments/assets/67bd9640-e13e-45e5-85b9-5121786f8426)
![snapshot_cn](https://github.com/user-attachments/assets/7fa5a28b-10d3-49f5-b4cb-9a3d58edd34c)

### 使用步骤
1.  通过**拖放**或点击 "➕" 按钮，分别添加源视频 / 音频、源字幕和目标视频 / 音频文件。拖放可以是文件夹，源视频 / 音频、源字幕可同时拖入，会自动分拣到对应的列表框。按钮只能添加文件，不能文件夹。
2.  输出目录如果为空，会根据目标视频 / 音频的输入进行自动设置，可按需要自行修改。
3.  检查列表框中的文件的行号是否正确一一对应，可以进行排序、删除、筛选等操作。
4.  点击 "运行" 按钮开始执行调轴任务，任务执行过程中的信息会显示在控制台中。
5.  如果需要中途终止，点击 "停止" 按钮（"停止"按钮在运行过程中才会显示）。

#### 注意: 
- 本程序建议使用Python 3.10+。虽然Python 3.8+可用，但这些低版本的Python版本可能导致界面功能缺失(例如列表框背景条纹间隔颜色消失)。
- 本程序依赖Python第三方模块：`aiofiles`、`charset_normalizer`、`tkinterdnd2`。可以执行`pip install -r reqiurements.txt` `pip install aiofiles charset_normalizer tkinterdnd2`安装这些模块。
- 可以在启动Subtitle Synchro Launcher时传入一个自定义配置的文件路径作为参数（Windows可新建一个快捷方式，在"目标"的末尾加一个空格后添加）。如果不带参数，也可以将`config.ini`放在程序所在的目录下，会自动读取。如果配置读取成功，本程序标题的profile会显示配置文件的名字。
- 本程序默认配置了sushi进行调轴，需要用到在系统中找到`ffmpeg`，`ffprobe`，`sushi`这3个命令。如果没在操作系统的环境变量中配置这3个命令，可以自行在`config.ini`配置这些命令对应程序的具体路径。
- 修改配置文件后需要重新启动程序才会生效。
- 并发数为1时，运行日志会实时输出。并发数大于1时，某个指令的运行日志会在指令执行完后再一次性输出（这样可以防止某个指令的日志被其它指令的日志乱入）。
- 输出目录输入框会将输入路径自动扩展绝对路径，输入`.`代表程序启动时的起始目录。
- 大部分功能区都做了提示，鼠标指针停留在上面一会就会有提示信息。


## 配置文件说明
**注意**：配置文件不支持直接写换行符，使用 "	"（tab键，即\t，但不能明写\t) 即表示换行符。
配置文件需要用utf-8编码。
开头使用`#`或`;`可注释掉一行（不能在行中进行注释）。

### 1\. 整体配置 [general]

|             选项              |                                                                                                                                                     描述                                                                                                                                                      |                                                       默认值                                                        |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| subtitle_ext                 | 字幕文件扩展名。用于筛选输入文件到字幕列表框。多个扩展名用逗号分隔。                                                                                                                                                                                                                                                  | `ass, srt, ssa`                                                                                                    |
| media_ext                    | 支持的视频/音频文件扩展名。用于筛选输入文件到视频/音频列表框。多个扩展名用逗号分隔。                                                                                                                                                                                                                                   | `mkv, mp4, m4a, avi, wmv, flv, rm, rmvb, mov, vob, mpeg, webm, mp3, wav, flac, ape, aac, ac3, opus, ogg, wma, amr` |
| launch_resolution            | 程序启动时的窗口分辨率。格式为 `宽度x高度`。                                                                                                                                                                                                                                                                      | `1440x600`                                                                                                         |
| min_resolution               | 程序窗口的最小分辨率。格式为 `宽度x高度`。                                                                                                                                                                                                                                                                        | `860x360`                                                                                                          |
| tips_trigger_time_ms         | 按钮提示信息触发时间（毫秒）。整数。                                                                                                                                                                                                                                                                              | `400`                                                                                                              |
| listbox_tips_trigger_time_ms | 列表框单元格提示信息触发时间（毫秒）。整数。                                                                                                                                                                                                                                                                       | `600`                                                                                                              |
| top_most                     | 程序启动时是否将窗口置顶。`yes`或`no`。                                                                                                                                                                                                                                                                          | `yes`                                                                                                              |
| checkbox_listbox_repeatable  | 列表框里能否有重复文件（此作为界面勾选框的默认值）。`yes`或`no`。                                                                                                                                                                                                                                                   | `yes`                                                                                                              |
| checkbox_input_file_sorted   | 是否将输入文件排序后加入列表框（此作为界面勾选框的默认值）。`yes`或`no`。                                                                                                                                                                                                                                            | `yes`                                                                                                              |
| default_output_dir           | 输出目录框的默认值。                                                                                                                                                                                                                                                                                            |                                                                                                                    |
| task_parallel_number         | 任务并行执行的数量。整数。                                                                                                                                                                                                                                                                                       | `3`                                                                                                                |
| task_stages                  | 每个任务要执行阶段的代号序列（不一定是数字，但建议不要用符号），多个代号用逗号分隔。`代号`即后续介绍的`[stage_*]`的`*`部分。一般每个任务都有几个命令要执行，每个命令可以定义为一个阶段，那么一个任务就有多个阶段要执行了，即这个阶段代号的列表。任意一个阶段运行失败（系统指令的返回值非0），就不会继续运行后续的阶段，整个task就会标记为fail。 | `1, 2, 3, 4, 5, 6`。                                                                                                |

### 2\. 样式配置 [style]
**注意**：由于操作系统兼容性问题，部分样式配置可能会不生效。

|                选项                |                     描述                      |       默认值       |
| --------------------------------- | --------------------------------------------- | ----------------- |
| fontname                          | 无字体配置选项的控件使用的字体                   | `Microsoft YaHei` |
| label_fontsize                    | 标签的字体大小                                 | `9`               |
| label_tips_fontsize               | 提示标签的字体大小                              | `9`               |
| label_outputdir_icon_fontsize     | 输出目录框图标的字体大小                         | `10`              |
| label_filter_icon_fontsize        | 筛选框图标的字体大小                            | `10`              |
| listbox_fontsize                  | 列表框的字体大小                                | `9`               |
| entry_fontsize                    | 输入框的字体大小                                | `10`              |
| console_fontname                  | 日志输出框的字体                                | `Microsoft YaHei` |
| console_fontsize                  | 日志输出框的字体大小                            | `10`              |
| context_menu_fontname             | 右键菜单的字体                                 | `Microsoft YaHei` |
| context_menu_fontsize             | 右键菜单的字体大小                              | `10`              |
| button_emoji_fontname             | 文本为图案的按钮的字体                          | `Microsoft YaHei` |
| button_emoji_fontsize             | 文本为图案的按钮的字体大小                       | `10`              |
| button_execute_fontsize           | 运行按钮的字体大小                              | `12`              |
| button_fontsize                   | 按钮的字体大小                                 | `10`              |
| button_top                        | 移至顶部按钮的文本                              | `⤒⤒`               |
| button_up                         | 上移按钮的文本                                 | `↑`               |
| button_down                       | 下移按钮的文本                                 | `↓`               |
| button_bottom                     | 移至底部按钮的文本                              | `⤓⤓`               |
| button_sort                       | 排序按钮的文本                                 | `⇅`               |
| button_add                        | 添加按钮的文本                                 | `➕`              |
| button_delete                     | 删除按钮的文本                                 | `✖`               |
| button_clear                      | 清空按钮的文本                                 | `🗑`              |
| button_topmost                    | 窗口置顶按钮的文本                              | `📌`              |
| button_directory                  | 输出目录框按钮的文本                            | `📁`              |
| button_filter                     | 筛选框按钮的文本                                | `🔍`              |
| color_frame_bg                    | 模块框的背景颜色                                | `#f0f0f0`         |
| color_label_bg                    | 标签控件的背景颜色                              | `#f0f0f0`         |
| color_label_border                | 标签控件的边框颜色                              | `#a0a0a0`         |
| color_progressbar                 | 进度条的颜色                                   | `#4a86e8`         |
| color_progressbar_bg              | 进度条的背景颜色                                | `#f0f0f0`         |
| color_progressbar_trough          | 进度条轨道的颜色                                | `#e6e6e6`         |
| color_checkbox_bg                 | 复选框的背景颜色                                | `#f0f0f0`         |
| color_button_font                 | 按钮的字体颜色                                 | `#333333`         |
| color_button_font_active          | 按钮激活时的字体颜色                            | `#0078d7`         |
| color_button_topmost_font         | 窗口置顶按钮的字体颜色                          | `#ff2222`         |
| color_button_topmost_font_active  | 窗口置顶按钮激活时的字体颜色                     | `#ff8888`         |
| color_button_execute_font         | 运行按钮的字体颜色                              | `#18a24b`         |
| color_button_stop_font            | 停止按钮的字体颜色                              | `#ff2222`         |
| color_listbox_font                | 列表框的字体颜色                                | `#000000`         |
| color_listbox_bg                  | 列表框的背景颜色                                | `#ffffff`         |
| color_odd_row_bg                  | 列表框奇数行的背景颜色                          | `#f5e6ff`         |
| color_even_row_bg                 | 列表框偶数行的背景颜色                          | `#ffffff`         |
| color_console_font                | 日志输出框的字体颜色                            | `#000000`         |
| color_console_error_font          | 日志输出框错误信息的字体颜色                     | `#ff0000`         |
| color_console_system_font         | 日志输出框系统信息的字体颜色                     | `#0000ff`         |
| color_console_bg                  | 日志输出框的背景颜色                            | `#ffffff`         |
| color_output_dir_entry_font       | 输出目录框的字体颜色                            | `#000000`         |
| color_output_dir_entry_bg         | 输出目录框的背景颜色                            | `#ffffff`         |
| color_output_dir_entry_height_fix | 输出目录框的高度修正值（字体上下显示不完整时候用） | `0`               |
| color_filter_entry_font           | 筛选框的字体颜色                                | `#000000`         |
| color_filter_entry_bg             | 筛选框的背景颜色                                | `#ffffff`         |
| color_filter_entry_height_fix     | 筛选框的高度修正值（字体上下显示不完整时候用）     | `0`               |
| color_tips_font                   | 提示框的字体颜色                                | `#000000`         |
| color_tips_bg                     | 提示框的背景颜色                                | `#ffffe0`         |

### 3\. 国际化配置 [i18n]
程序里内置了英语和简体中文的i18n配置，对着翻译成其它语言即可，就不多阐述了。

### 4\. 变量配置 [variable]
变量配置在每个任务运行前会*重新单独逐行替换一遍*变量`{XXX}`。如果找不到要替换的变量就会报错。后面行的变量可以用前面行定义的变量。
有一些是保留的变量。保留变量和`_exe`为后缀的变量不能进行覆盖操作。其它变量可以被各阶段的运行输出所覆盖。后续阶段就会用覆盖后的值去替换阶段的配置变量。
**注意**：`_exe`为后缀的变量（譬如`XXX_exe`）是**不会**进行变量替换的（即如果其值含有`{YYY}`，是不会把`{YYY}`替换成对应值的）。如果其值是路径，`路径所处的目录`会加入到task运行时的`环境变量的PATH`的前头。

|         选项         |                                                                                                   描述                                                                                                   |                                         默认值                                         |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------- |
| output_dir          | 保留变量。输出目录。                                                                                                                                                                                      | 输出目录框的值                                                                          |
| task_id             | 保留变量。任务编号（即文件列表框的行号）。                                                                                                                                                                   | 任务编号（即文件列表框的行号）                                                            |
| temp_dir            | 保留变量。临时目录。如果此选项出现过在配置中，则会在任务执行前自动创建目录，执行完自动删除。                                                                                                                      | {output_dir}_tmp{当前时间yyMMddHHmmss}-{task_id}                                        |
| src_media           | 保留变量。本任务的源视频/音频的绝对路径。                                                                                                                                                                    | 源视频/音频的绝对路径                                                                    |
| src_media_name      | 保留变量。本任务的源视频/音频的文件名（不带后缀）。                                                                                                                                                           | 源视频/音频的文件名（不带后缀）                                                           |
| src_media_suffix    | 保留变量。本任务的源视频/音频的后缀（不带点号`.`）。                                                                                                                                                          | 源视频/音频的后缀（不带点号`.`）                                                          |
| src_media_dir       | 保留变量。本任务的源视频/音频的所在目录的绝对路径（除盘符/根目录外，末尾没有`\`或`/`）。                                                                                                                         | 源视频/音频的所在目录的绝对路径（除盘符/根目录外，末尾没有`\`或`/`）                         |
| src_subtitle        | 保留变量。本任务的源字幕的绝对路径。                                                                                                                                                                        | 源字幕的绝对路径                                                                        |
| src_subtitle_name   | 保留变量。本任务的源字幕的文件名（不带后缀）。                                                                                                                                                               | 源字幕的文件名（不带后缀）                                                                |
| src_subtitle_suffix | 保留变量。本任务的源字幕的后缀（不带点号`.`）。                                                                                                                                                              | 源字幕的后缀（不带点号`.`）                                                              |
| src_subtitle_dir    | 保留变量。本任务的源字幕的所在目录的绝对路径（除盘符/根目录外，末尾没有`\`或`/`）。                                                                                                                              | 源字幕的所在目录的绝对路径（除盘符/根目录外，末尾没有`\`或`/`）                              |
| dst_media           | 保留变量。本任务的目标视频/音频的绝对路径。                                                                                                                                                                  | 目标视频/音频的绝对路径                                                                  |
| dst_media_name      | 保留变量。本任务的目标视频/音频的文件名（不带后缀）。                                                                                                                                                         | 目标视频/音频的文件名（不带后缀）                                                         |
| dst_media_suffix    | 保留变量。本任务的目标视频/音频的后缀（不带点号`.`）。                                                                                                                                                        | 目标视频/音频的后缀（不带点号`.`）                                                        |
| dst_media_dir       | 保留变量。本任务的目标视频/音频的所在目录的绝对路径（除盘符/根目录外，末尾没有`\`或`/`）。                                                                                                                       | 目标视频/音频的所在目录的绝对路径（除盘符/根目录外，末尾没有`\`或`/`）                        |
| ffmpeg_exe          | FFmpeg 可执行文件的路径。`_exe`后缀的变量。其值如果有变量，不会进行变量替换。                                                                                                                                  | ffmpeg                                                                                 |
| ffprobe_exe         | FFprobe 可执行文件的路径。`_exe`后缀的变量。其值如果有变量，不会进行变量替换。内置过程`get_audio_stream_idx`、`shift_source_subtitle_timeline_delay`、`shift_destination_subtitle_timeline_delay`需要用到此变量。 | ffprobe                                                                                |
| sushi_exe           | sushi 可执行文件的路径。`_exe`后缀的变量。其值如果有变量，不会进行变量替换。                                                                                                                                   | sushi                                                                                  |
| 除上述以外的其它变量   | 可随意自定义和被阶段的运行输出改动。                                                                                                                                                                        | 根据需要修改文件路径模板，如 `{temp_dir}/{src_media_name}.stage1.{src_subtitle_suffix}`。 |

### 5\. 阶段配置 [stage_*]
这部分可以命名为`stage_*`，其中`*`表示`代号`，可以被`[general]`下的`task_stages`引用。比如，定义了`stage_aa`、`stage_bc`、`stage_7`，则可在`[general]`下这样写`task_stages = bc, aa`。可以定义多个`stage_*`而不去使用。
一般一个任务都有几个命令要执行，每个命令可以定义为一个阶段。
默认配置定义了`stage_0`、`stage_1`、`stage_2`、`stage_3`、`stage_4`、`stage_5`、`stage_6`共7个阶段。用户可以覆盖配置，但不建议。如果要新建阶段，建议另起阶段代号，把默认配置的阶段留着不用就好。

每个阶段可以配置以下选项：

|    选项     |                                                                                                                                    描述                                                                                                                                    |
| ----------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| procedure   | 必填项。程序所定义的工序的名字。可选择`convert_file_to_utf8`、`get_audio_stream_idx`、`execute_command`、`shift_source_subtitle_timeline_delay`、`shift_destination_subtitle_timeline_delay`。                                                                                  |
| input       | 必填项。工序的输入参数。                                                                                                                                                                                                                                                     |
| output_key  | 工序执行完把输出的字符串内容存到此定义的变量中（无需在`[variable]`中预定义变量）。一般情况下，这个值是不带`{}`的（带`{}`的话就代表存到这个`{}`的值所代表的变量。举个例子，如果在`[variable]`中定义了变量`aa=bbb`，那么在这里填`{aa}`的话，输出的字符串就会存到`bbb`变量里了，而并不是`aa`变量里）。 |
| output_file | 工序执行完把输出的字符串内容存到此定义路径的文件中。（能与`output_key`同时存在，表示输出即存到变量中，也把输出存到文件中。`output_key`和`output_file`也能同时不存在，表示无需输出）                                                                                                       |

各工序的定义如下：

|                    工序                    |                                                                                                                      描述                                                                                                                       |                                                输入                                                 |                                                        输出                                                        |
| ----------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------- |
| convert_file_to_utf8                      | 把文件转换为utf-8格式                                                                                                                                                                                                                            | 文件路径（一般是字幕文件）                                                                            | 文件转换后的utf-8字符串                                                                                             |
| get_audio_stream_idx                      | 获取第1个音轨的轨道索引号                                                                                                                                                                                                                         | 文件路径（一般是视频/音频文件）                                                                       | 轨道索引号                                                                                                         |
| execute_command                           | 调用系统指令（命令行），执行完后若系统返回非0，此工序就会当作失败。                                                                                                                                                                                    | 系统指令的字符串（如果某个参数有空格，要用双引号括起来。但变量`{XXX}`的值里可能出现空格就不需要把变量括起来） | 系统执行指令的输出                                                                                                  |
| shift_source_subtitle_timeline_delay      | 将字幕的起始时间由`以视频播放的开始时间（不一定是视频轨的开始时间）为起点匹配`调整为`以指定的音轨的开始时间为起点匹配`。如果输入的是音频而不是视频，则判断音频名字中是否带有延迟来获取延迟（一般MKVExtractGUI导出音轨会把延迟值写在文件名中）。 一般用于sushi的前置处理。 | 三个参数：`视频/音频` `音轨的轨道索引号` `字幕文件（可任意编码，不一定utf-8）`                            | 调轴后的字幕文件的utf-8字符串（**注意**：此方法会将字幕文件转为utf-8字符串输出，可视为自带了`convert_file_to_utf8`的功能） |
| shift_destination_subtitle_timeline_delay | 将字幕的起始时间由`以指定的音轨的开始时间为起点匹配`调整为`以视频播放的开始时间（不一定是视频轨的开始时间）为起点匹配`。如果输入的是音频而不是视频，则判断音频名字中是否带有延迟来获取延迟（一般MKVExtractGUI导出音轨会把延迟值写在文件名中）。 一般用于sushi的后置处理。 | 三个参数：`视频/音频` `音轨的轨道索引号` `字幕文件（可任意编码，不一定utf-8）`                            | 调轴后的字幕文件的utf-8字符串（**注意**：此方法会将字幕文件转为utf-8字符串输出，可视为自带了`convert_file_to_utf8`的功能） |

## 许可证
MIT 许可证。详情请参阅[此处的许可证](./LICENSE)。
界面布局参考[字幕文件批量改名](https://soft.3dmgame.com/down/286840.html)。
